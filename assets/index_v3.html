<!DOCTYPE html>
<html>
 <head> 
  <title>Web Proxy</title> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@1.0.0/dist/css/mdui.min.css" crossorigin="anonymous" /> 
  <script src="https://cdn.jsdelivr.net/npm/mdui@1.0.0/dist/js/mdui.min.js" crossorigin="anonymous">
</script> 
  <link rel="icon" type="image/ico" href="https://cdn.jsdelivr.net/gh/ShiSheng233/Blog_Picture/internet.png" /> 
  <meta charset="utf-8" /> 
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" /> 
  <base target="_blank" /> 
  <style>
    body {padding: 0 0.5em;}
    .box {
      margin-top: 10em;
    }
    #txtURL {width: 100%;height: 2em;text-indent: 0.5em;padding: 0.25em 0;}
    #btnGo_1 {width: 100%;font-size: 1.5em;}
  </style> 
 </head> 
 <body class="mdui-theme-primary-pink mdui-theme-accent-pink mdui-theme-layout-auto"> 
  <header class="mdui-appbar"> 
   <div class="mdui-toolbar mdui-color-pink"> 
    <span class="mdui-typo-title">Web Proxy</span> 
   </div> 
  </header> 
  <div class="mdui-textfield mdui-textfield-floating-label" onkeydown="if(event.keyCode==13){event.keyCode=0;event.returnValue=false;}"> 
   <i class="mdui-icon material-icons">public</i> 
   <label class="mdui-textfield-label">URL</label> 
   <input id="txtURL" class="mdui-textfield-input" type="text"/> 
   <div class="mdui-textfield-helper">输入一个你想代理访问的网址</div>
  </div> 
  <div> 
   <button id="btnGo_1" class="mdui-btn mdui-color-theme-accent mdui-btn-raised mdui-color-theme-300 mdui-ripple" mdui-dialog="{target: '#go_or_not'}">Go</button> 
   <div class="mdui-dialog" id="go_or_not"> 
    <div class="mdui-dialog-title">注意</div> 
    <div class="mdui-dialog-content">请不要在任何一个网站登录账号！</div> 
    <div class="mdui-dialog-actions mdui-dialog-actions-stacked"> 
     <button id="btnGo" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">我已了解，冲冲冲</button> 
     <button class="mdui-btn mdui-ripple" mdui-dialog-close="">取消</button> 
    </div> 
   </div> 
  </div> 
  <!--
  <div class="box">
    <span>线路:</span>
    <select id="selNode" class="mdui-select"></select>
  </div>
  -->  
  <script>
    const PAGE_CONF_SET = 110
    const PAGE_CONF_GET = 111

    const SW_CONF_RETURN = 112
    const SW_CONF_CHANGE = 113

    const PAGE_READY_CHECK = 200
    const SW_READY = 201

    const sw = navigator.serviceWorker


    sw.addEventListener('message', onSwMsg)
    sendMsgToSw(PAGE_READY_CHECK)

    btnGo.onclick = function() {
      const text = txtURL.value.trim()
      if (text) {
        const url = './-----' + text
        open(url, '_blank', 'noopener,noreferrer')
      }
    }
    txtURL.onkeypress = function(e) {
      if (e.keyCode === 13) {
        btnGo.onclick()
      }
    }
    txtURL.setSelectionRange(0, txtURL.value.length)


    function onSwMsg(e) {
      const [cmd, msg] = e.data

      switch (cmd) {
      case SW_CONF_RETURN:
        conf = msg
        showConf()
        break

      case SW_CONF_CHANGE:
        conf = msg
        updateSelected()
        break

      case SW_READY:
        console.log('sw ready')
        sendMsgToSw(PAGE_CONF_GET)
        break
      }
    }

    function onSwFail(err) {
      txtURL.value = err
    }
    /*
    selNode.onchange = function() {
      const item = this.options[this.selectedIndex]
      const node = item.value
      conf.node_default = node
      sendMsgToSw(PAGE_CONF_SET, conf)
    }
    */
    function sendMsgToSw(cmd, val) {
      const ctl = sw.controller
      if (!ctl) {
        console.log('ctl is null')
        return
      }
      ctl.postMessage([cmd, val])
    }

    function addNodeItem(id, text) {
      const optEl = document.createElement('option')
      optEl.id = '--' + id
      optEl.text = text
      optEl.value = id
      //selNode.appendChild(optEl)
    }

    function updateSelected() {
      const id = conf.node_default
      const item = document.getElementById('--' + id)
      if (item) {
        item.selected = true
      } else {
        console.warn('unknown node:', id)
      }
    }

    function showConf() {
      for (const [id, node] of Object.entries(conf.node_map)) {
        if (!node.hidden) {
          addNodeItem(id, node.label)
        }
      }
      updateSelected()
    }
  </script>  
 </body>
</html>